–ê–≥–∞, —Ä–µ—á—å –∏–¥—ë—Ç –ø—Ä–æ **–∏–Ω–ª–∞–π–Ω–∏–Ω–≥** (inlining) ‚Äî —ç—Ç–æ –≥–ª–∞–≤–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö –º–µ—Ç–æ–¥–æ–≤, –∫–æ—Ç–æ—Ä—É—é –¥–µ–ª–∞–µ—Ç JIT.

---

### üîπ –ß—Ç–æ —Ç–∞–∫–æ–µ –∏–Ω–ª–∞–π–Ω–∏–Ω–≥

–ò–Ω–ª–∞–π–Ω–∏–Ω–≥ = **–≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏–µ —Ç–µ–ª–∞ –º–µ—Ç–æ–¥–∞ –ø—Ä—è–º–æ –≤ –º–µ—Å—Ç–æ –≤—ã–∑–æ–≤–∞**, –≤–º–µ—Å—Ç–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤—ã–∑–æ–≤–∞ –ø–æ —Å—Ç–µ–∫—É.

–ü—Ä–∏–º–µ—Ä:

```csharp
int Square(int x) => x * x;

int Calc(int a, int b) => Square(a) + Square(b);
```

–ë–µ–∑ –∏–Ω–ª–∞–π–Ω–∞ JIT —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç:

* –≤—ã–∑–æ–≤ `Square(a)` ‚Üí –∑–∞—Ö–æ–¥ –≤ –º–µ—Ç–æ–¥, —Å–æ–∑–¥–∞–Ω–∏–µ –∫–∞–¥—Ä–∞ —Å—Ç–µ–∫–∞, –≤–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.
* –≤—ã–∑–æ–≤ `Square(b)` ‚Üí —Ç–æ –∂–µ —Å–∞–º–æ–µ.

–° –∏–Ω–ª–∞–π–Ω–æ–º:

```csharp
int Calc(int a, int b) => (a * a) + (b * b);
```

–ù–µ—Ç –≤—ã–∑–æ–≤–æ–≤, –Ω–µ—Ç –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ ‚Üí –±—ã—Å—Ç—Ä–µ–µ, –º–µ–Ω—å—à–µ –º—É—Å–æ—Ä–∞ –≤ —Å—Ç–µ–∫–µ.

---

### üîπ –ü–æ—á–µ–º—É —Ç–æ–ª—å–∫–æ –º–∞–ª–µ–Ω—å–∫–∏–µ –º–µ—Ç–æ–¥—ã

* –£ –∏–Ω–ª–∞–π–Ω–∏–Ω–≥–∞ **—Ü–µ–Ω–∞**: –Ω—É–∂–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å IL –≤ –º–µ—Å—Ç–æ –≤—ã–∑–æ–≤–∞.
* –ï—Å–ª–∏ –º–µ—Ç–æ–¥ –±–æ–ª—å—à–æ–π ‚Üí –∫–æ–¥ —Ä–∞–∑–¥—É–≤–∞–µ—Ç—Å—è, CPU-–∫—ç—à —Ö—É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Üí –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–∞–∂–µ –º–µ–¥–ª–µ–Ω–Ω–µ–µ.
* –ü–æ—ç—Ç–æ–º—É JIT –ø—Ä–∏–º–µ–Ω—è–µ—Ç —ç–≤—Ä–∏—Å—Ç–∏–∫—É: ¬´–º–∞–ª–µ–Ω—å–∫–∏–π –∏ –ø—Ä–æ—Å—Ç–æ–π –º–µ—Ç–æ–¥ ‚Üí –≤—Å—Ç—Ä–∞–∏–≤–∞–µ–º¬ª.

–û–±—ã—á–Ω–æ JIT —Å—á–∏—Ç–∞–µ—Ç ¬´–º–∞–ª–µ–Ω—å–∫–∏–º¬ª –º–µ—Ç–æ–¥, –µ—Å–ª–∏ –µ–≥–æ IL ‚â§ \~32 –±–∞–π—Ç–∞ (—É .NET Core / .NET 5+ –ø–æ—Ä–æ–≥ –≤—ã—Ä–æ—Å, –Ω–æ –ø—Ä–∏–Ω—Ü–∏–ø —Ç–æ—Ç –∂–µ).

---

### üîπ –≠—Ñ—Ñ–µ–∫—Ç—ã –∏–Ω–ª–∞–π–Ω–∏–Ω–≥–∞

1. **–°–∫–æ—Ä–æ—Å—Ç—å**: –º–µ–Ω—å—à–µ –≤—ã–∑–æ–≤–æ–≤ –º–µ—Ç–æ–¥–æ–≤ ‚Üí –º–µ–Ω—å—à–µ –ø—Ä—ã–∂–∫–æ–≤ ‚Üí –ª—É—á—à–µ branch prediction.
2. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–∞–ª—å—à–µ**: –∫–æ–≥–¥–∞ –º–µ—Ç–æ–¥ –≤—Å—Ç—Ä–æ–µ–Ω, JIT –º–æ–∂–µ—Ç:

    * —É–ø—Ä–æ—Å—Ç–∏—Ç—å –≤—ã—Ä–∞–∂–µ–Ω–∏—è,
    * —É–±—Ä–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, null-check),
    * —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞—Ç—å —Ü–∏–∫–ª—ã.
3. **–ú–µ–Ω—å—à–µ –∞–ª–ª–æ–∫–∞—Ü–∏–π**: –∏–Ω–æ–≥–¥–∞ —É–±–∏—Ä–∞–µ—Ç—Å—è —Å–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ (escape analysis).

---

### üîπ –ü—Ä–∏–º–µ—Ä –≤ JIT (—É–ø—Ä–æ—â—ë–Ω–Ω–æ)

```csharp
int AddOne(int x) => x + 1;

int Test(int y) => AddOne(y) + 5;
```

* –ë–µ–∑ –∏–Ω–ª–∞–π–Ω–∞:

  ```
  call AddOne
  add 5
  ```

  ‚Üí –ª–∏—à–Ω–∏–π –≤—ã–∑–æ–≤.

* –° –∏–Ω–ª–∞–π–Ω–æ–º:

  ```
  add y, 1
  add 5
  ```

  ‚Üí –≤—ã–∑–æ–≤–∞ –º–µ—Ç–æ–¥–∞ –Ω–µ—Ç.

---

### üîπ –ò —Å–≤—è–∑—å —Å —Ç–≤–æ–∏–º ThrowHelper

–ï—Å–ª–∏ —Ç—ã –ø—Ä—è–º–æ –≤ `set` Id –ø–∏—à–µ—à—å:

```csharp
if (!IsTransient)
    throw new InvalidOperationException($"...");
```

‚Üí –ú–µ—Ç–æ–¥ `set` —Ä–∞–∑—Ä–∞—Å—Ç–∞–µ—Ç—Å—è, JIT –Ω–µ —Å–º–æ–∂–µ—Ç –µ–≥–æ –∏–Ω–ª–∞–π–Ω–∏—Ç—å —Ç—É–¥–∞, –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–≤–æ–π Entity.

–ï—Å–ª–∏ –≤—ã–Ω–µ—Å—Ç–∏ –≤:

```csharp
if (!IsTransient)
    ThrowHelper.ThrowIdAlreadySet(GetType().Name, nameof(Id), typeof(TKey).Name);
```

‚Üí `set` –æ—Å—Ç–∞—ë—Ç—Å—è –º–∞–ª–µ–Ω—å–∫–∏–º (–ø–∞—Ä–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π + `call`), JIT –µ–≥–æ –º–æ–∂–µ—Ç –∑–∞–∏–Ω–ª–∞–π–Ω–∏—Ç—å –≤ –¥—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã, –∞ —Å–∞–º `ThrowHelper` —É–µ–∑–∂–∞–µ—Ç –≤ cold path.

---

‚úÖ –ò—Ç–æ–≥:

* ¬´–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –º–∞–ª–µ–Ω—å–∫–∏—Ö –º–µ—Ç–æ–¥–æ–≤¬ª = –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å **–∏–Ω–ª–∞–π–Ω–∏–Ω–≥**.
* JIT –æ—Ö–æ—Ç–Ω–µ–µ –∏–Ω–ª–∞–π–Ω–∏—Ç –∫–æ—Ä–æ—Ç–∫–∏–µ –º–µ—Ç–æ–¥—ã ‚Üí –º–µ–Ω—å—à–µ –≤—ã–∑–æ–≤–æ–≤, –ª—É—á—à–µ –∫—ç—à, –±—ã—Å—Ç—Ä–µ–µ —Ä–∞–±–æ—Ç–∞.
* –ü–æ—ç—Ç–æ–º—É runtime-–∫–æ–º–∞–Ω–¥–∞ BCL –≤—Å–µ–≥–¥–∞ —Å—Ç–∞—Ä–∞–µ—Ç—Å—è –≤—ã–Ω–µ—Å—Ç–∏ —Ç—è–∂—ë–ª—ã–π –∫–æ–¥ (`throw`) –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π helper, —á—Ç–æ–±—ã –æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –æ—Å—Ç–∞–≤–∞–ª—Å—è –º–∞–ª–µ–Ω—å–∫–∏–º –∏ –≤—Å—Ç—Ä–∞–∏–≤–∞–ª—Å—è.

---

–•–æ—á–µ—à—å, —è –Ω–∞–∫–∏–Ω—É –ø—Ä–∏–º–µ—Ä —Å —Ç–≤–æ–∏–º `EntityRoot<TKey>` –∏ –ø–æ–∫–∞–∂—É, –∫–∞–∫ —Å–µ—Ç—Ç–µ—Ä `Id` –≤–µ–¥—ë—Ç —Å–µ–±—è –≤ JIT —Å –∏–Ω–ª–∞–π–Ω–æ–º –∏ –±–µ–∑ –Ω–µ–≥–æ (—á–µ—Ä–µ–∑ SharpLab dump)?
